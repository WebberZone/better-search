class SearchAutocomplete{static SELECTOR='.search-form, form[role="search"]';static DEBOUNCE_DELAY=300;static CACHE_TIMEOUT=3e5;constructor(e){this.form=e,this.searchInput=e.querySelector('input[name="s"]'),this.submitButton=e.querySelector('input[type="submit"], button[type="submit"]'),this.selectedIndex=-1,this.debounceTimer=null,this.cache=new Map,this.searchInput&&(this.initializeElements(),this.bindEvents())}initializeElements(){this.announceRegion=this.createAnnounceRegion(),this.form.insertBefore(this.announceRegion,this.form.firstChild),this.resultsContainer=this.createResultsContainer(),this.insertResultsContainer(),this.configureSearchInput()}createAnnounceRegion(){const e=document.createElement("div");return e.className="bsearch-visually-hidden",e.setAttribute("aria-live","assertive"),e.id=`announce-${this.generateId()}`,e}createResultsContainer(){const e=document.createElement("div");return e.className="bsearch-autocomplete-results",e.setAttribute("role","listbox"),e.id=`search-suggestions-${this.generateId()}`,e}generateId(){return Math.random().toString(36).substring(2,9)}insertResultsContainer(){const e=this.submitButton||this.searchInput;e.parentNode.insertBefore(this.resultsContainer,e.nextSibling)}configureSearchInput(){Object.entries({autocomplete:"off","aria-autocomplete":"list","aria-controls":this.resultsContainer.id,autocapitalize:"off",spellcheck:"false"}).forEach((([e,t])=>{this.searchInput.setAttribute(e,t)}))}bindEvents(){this.form.addEventListener("submit",(()=>this.clearCache())),this.searchInput.addEventListener("input",this.handleInput.bind(this)),this.searchInput.addEventListener("keydown",this.handleInputKeydown.bind(this)),this.searchInput.addEventListener("focus",this.handleInputFocus.bind(this)),this.searchInput.addEventListener("blur",this.handleInputBlur.bind(this)),this.submitButton&&this.submitButton.addEventListener("keydown",this.handleSubmitKeydown.bind(this)),this.resultsContainer.addEventListener("keydown",this.handleResultsKeydown.bind(this)),this.resultsContainer.addEventListener("DOMNodeInserted",this.handleResultInsert.bind(this)),document.addEventListener("click",this.handleDocumentClick.bind(this))}handleInput(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((()=>{const e=this.searchInput.value.trim();e.length>2?(this.announce(bsearch_live_search.strings.searching),this.fetchResults(e)):(this.announce(0===e.length?"":bsearch_live_search.strings.min_chars),this.clearResults())}),SearchAutocomplete.DEBOUNCE_DELAY)}handleInputKeydown(e){const t=this.resultsContainer.querySelectorAll("li");switch(e.key){case"Escape":e.preventDefault(),this.clearResults(),this.announce(bsearch_live_search.strings.suggestions_closed);break;case"ArrowDown":e.preventDefault(),this.handleArrowDown(t);break;case"ArrowUp":e.preventDefault(),this.handleArrowUp(t);break;case"Enter":this.handleEnter(t,e);break}}handleArrowDown(e){!e.length&&this.searchInput.value.length>2?this.fetchResults(this.searchInput.value):(this.selectedIndex=e.length?Math.min(this.selectedIndex+1,e.length-1):0,this.updateSelection(e))}handleArrowUp(e){e.length&&(this.selectedIndex=this.selectedIndex>0?this.selectedIndex-1:e.length-1,this.updateSelection(e))}handleEnter(e,t){if(e.length&&this.selectedIndex>=0){t.preventDefault();const s=e[this.selectedIndex].querySelector("a");s?.href&&(this.announce(bsearch_live_search.strings.navigating_to.replace("%s",s.textContent)),window.location.href=s.href)}else this.announce(bsearch_live_search.strings.submitting_search),this.form.submit()}handleSubmitKeydown(e){const t=this.resultsContainer.querySelectorAll("li");switch(e.key){case"Escape":e.preventDefault(),this.clearResults(),this.searchInput.focus(),this.announce(bsearch_live_search.strings.suggestions_closed);break;case"ArrowDown":if(!t.length)return;e.preventDefault(),this.selectedIndex=0,this.updateSelection(t);break;case"ArrowUp":e.preventDefault(),this.searchInput.focus(),this.announce(bsearch_live_search.strings.back_to_input);break}}handleResultsKeydown(e){const t=this.resultsContainer.querySelectorAll("li");if(t.length)switch(e.key){case"ArrowDown":e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,t.length-1),this.updateSelection(t);break;case"ArrowUp":e.preventDefault(),this.handleResultsArrowUp(t);break;case"Escape":e.preventDefault(),this.clearResults(),this.searchInput.focus(),this.announce(bsearch_live_search.strings.suggestions_closed);break;case"Enter":e.preventDefault(),this.handleResultsEnter(t);break}}handleResultsArrowUp(e){0===this.selectedIndex?((this.submitButton||this.searchInput).focus(),this.selectedIndex=-1,this.announce(bsearch_live_search.strings.back_to_search)):(this.selectedIndex--,this.updateSelection(e))}handleResultsEnter(e){if(this.selectedIndex>=0&&this.selectedIndex<e.length){const t=e[this.selectedIndex].querySelector("a");t?.href?(this.announce(bsearch_live_search.strings.navigating_to.replace("%s",t.textContent)),window.location.href=t.href):(this.searchInput.value=e[this.selectedIndex].textContent,this.form.submit())}}handleResultInsert(e){"A"===e.target.tagName&&e.target.removeAttribute("tabindex")}handleDocumentClick(e){this.form.contains(e.target)||this.resultsContainer.contains(e.target)||this.clearResults()}handleInputFocus(){this.resultsContainer.innerHTML.trim()&&this.searchInput.value.length>2&&(this.resultsContainer.style.display="block")}handleInputBlur(){setTimeout((()=>{this.clearResults(),this.announce("Search suggestions closed")}),100)}announce(e){this.announceRegion.textContent=e}clearResults(){this.resultsContainer.innerHTML="",this.resultsContainer.style.display="none",this.selectedIndex=-1,this.searchInput.removeAttribute("aria-activedescendant"),this.announceRegion.textContent=""}updateSelection(e){e.forEach((e=>{e.classList.remove("bsearch-selected"),e.setAttribute("aria-selected","false")}));const t=e[this.selectedIndex];t&&(t.classList.add("bsearch-selected"),t.setAttribute("aria-selected","true"),t.scrollIntoView({block:"nearest"}),this.searchInput.setAttribute("aria-activedescendant",t.id),this.announce(t.textContent))}getCachedResults(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>SearchAutocomplete.CACHE_TIMEOUT?(this.cache.delete(e),null):t.results}cacheResults(e,t){if(this.cache.size>50){const e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(e,{results:t,timestamp:Date.now()})}clearCache(){this.cache.clear()}async fetchResults(e){try{const t=this.getCachedResults(e);if(t)return void this.displayResults(t);const s=await fetch(bsearch_live_search.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},body:new URLSearchParams({action:"bsearch_live_search",s:e}).toString()}),n=await s.json();this.cacheResults(e,n),this.displayResults(n)}catch(e){this.clearResults(),this.announce(bsearch_live_search.strings.error_loading)}}displayResults(e){if(this.resultsContainer.innerHTML="",!e.length)return void this.announce(bsearch_live_search.strings.no_suggestions);const t=document.createElement("ul");t.setAttribute("role","listbox"),e.forEach(((e,s)=>{const n=document.createElement("li");n.setAttribute("role","option"),n.setAttribute("aria-selected","false"),n.id=`search-suggestion-${s}`;const i=document.createElement("a");i.href=e.link,i.textContent=e.title,n.appendChild(i),t.appendChild(n)})),this.resultsContainer.appendChild(t),this.resultsContainer.style.display="block",this.announce(bsearch_live_search.strings.suggestions_found.replace("%d",e.length))}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(SearchAutocomplete.SELECTOR).forEach((e=>new SearchAutocomplete(e)))}));